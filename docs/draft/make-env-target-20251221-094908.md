# Design Draft: Add `make env` Target to Replace/Supplement `setup.sh`

**Created**: 2025-12-21 09:49:08
**Status**: Draft - Brainstorming Complete

## Executive Summary

Add a `make env` target to generated Makefiles as an alternative to `source setup.sh` for environment setup. This provides a Makefile-centric interface while maintaining backward compatibility with the existing `setup.sh` approach.

## Problem Statement

The current Agentize SDK generates a `setup.sh` script for environment setup. While the script uses portable path resolution (`${BASH_SOURCE[0]}`), some users prefer a Makefile-centric approach where all project interactions go through `make` targets. This improves:

1. **Discoverability**: `make help` shows available targets
2. **Consistency**: Single interface for all project operations
3. **Regeneration**: Dynamic generation with current `$(CURDIR)` value

## Design Decision Record

### Key Decisions Made

| Decision | Choice | Rationale | Alternatives Considered |
|----------|--------|-----------|------------------------|
| Approach | Dual support (both `make env` and `setup.sh`) | Backward compatibility while adding new functionality | Replace setup.sh entirely (breaking change) |
| `make env` behavior | Print export statements for `eval` | Simple, standard pattern; no file I/O | Generate script file, modify shell directly (impossible) |
| Additional target | Add `make env-script` | Regenerate `setup.sh` on demand | Single target doing both (confusing UX) |
| Default interface | Keep `source setup.sh` as primary | Less disruptive to existing users | Make `make env` primary |

### Critical Issues Resolved

1. **Shell environment limitation**: Makefile targets run in subshells and cannot directly modify parent shell environment. Resolved by outputting export statements for use with `eval $(make env)`.

2. **Path portability**: The existing `setup.sh` uses `${BASH_SOURCE[0]}` which is portable. The `make env` target uses `$(CURDIR)` which is equally portable in Makefile context.

### Acknowledged Tradeoffs

1. **User friction with `eval`**: Users must type `eval $(make env)` instead of `source setup.sh`. Mitigated by clear documentation and keeping `setup.sh` as an option.

2. **Two ways to do the same thing**: Having both `source setup.sh` and `make env` may confuse some users. Mitigated by clear documentation explaining when to use each.

## Design Specification

### Overview

Modify the Makefile generation in `scripts/install.sh` to include environment setup targets. The changes affect the generated Makefile header and optionally the language-specific templates.

### Key Components

1. **`make env` target**: Outputs shell export statements to stdout for use with `eval`
2. **`make env-script` target**: Generates/regenerates `setup.sh` with current paths
3. **Updated help text**: Documents new targets in `make help` output

### Interface Specification

#### `make env` Target

**Purpose**: Output environment variable exports for the current shell

**Usage**:
```bash
eval $(make env)
```

**Output format**:
```bash
export PROJECT_ROOT="/path/to/project"
export PATH="/path/to/project/build/bin:$PATH"
# Language-specific exports follow
```

#### `make env-script` Target

**Purpose**: Generate/regenerate `setup.sh` with current project path

**Usage**:
```bash
make env-script
source setup.sh
```

**Behavior**:
- Creates `setup.sh` in project root
- Uses `$(CURDIR)` for PROJECT_ROOT (resolved at make time)
- Overwrites existing `setup.sh` if present
- Makes script executable

### Implementation Details

#### Changes to `scripts/install.sh`

In `generate_enhanced_makefile()`, add after the main targets section:

```makefile
# ============================================================================
# Environment Setup
# ============================================================================

.PHONY: env
env:
	@echo 'export PROJECT_ROOT="$(CURDIR)"'
	@echo 'export PATH="$(CURDIR)/build/bin:$$PATH"'
# Language-specific additions inserted here

.PHONY: env-script
env-script:
	@echo "Generating setup.sh..."
	@echo '#!/bin/bash' > setup.sh
	@echo '# Generated by make env-script' >> setup.sh
	@echo 'PROJECT_ROOT="$(CURDIR)"' >> setup.sh
	@echo 'export PROJECT_ROOT' >> setup.sh
	@echo 'export PATH="$$PROJECT_ROOT/build/bin:$$PATH"' >> setup.sh
# Language-specific additions inserted here
	@chmod +x setup.sh
	@echo "Generated setup.sh - run: source setup.sh"
```

#### Language-Specific Additions

**Python** (append to `templates/python/Makefile.template` or inject in install.sh):
```makefile
# In env target:
	@echo 'export PYTHONPATH="$(CURDIR)/src:$$PYTHONPATH"'
```

**Rust** (append to `templates/rust/Makefile.template` or inject in install.sh):
```makefile
# In env target:
	@echo 'export CARGO_TARGET_DIR="$(CURDIR)/target"'
```

#### Changes to README.md

Update "Required Interface" section:

```markdown
## Required Interface

Your project must provide these standard commands:

```bash
# Environment setup (choose one):
source setup.sh           # Option 1: Source script directly
eval $(make env)          # Option 2: Makefile-based setup

# Build the project
make build

# Run test suite
make test
```
```

Update `make help` output to include:
```
  env       - Print environment exports (use: eval $(make env))
  env-script - Generate setup.sh script
```

### Constraints

1. Must not break existing `setup.sh` functionality
2. Must work with bash 3.2+ (macOS compatibility)
3. Must handle all supported languages (Python, C, C++, Rust)
4. Output must be safely eval-able (no command injection)

## Research References

### Internal References
- `/Users/were/repos/playground/agentize/scripts/install.sh`: Main installation script with `generate_enhanced_makefile()` function (lines 433-546)
- `/Users/were/repos/playground/agentize/claude/templates/project-setup.sh.template`: Current setup.sh template showing environment variables to replicate
- `/Users/were/repos/playground/agentize/templates/python/Makefile.template`: Python-specific Makefile template
- `/Users/were/repos/playground/agentize/templates/cxx/Makefile.template`: C++ Makefile template

### External References
- GNU Make `$(CURDIR)` variable documentation
- Bash `eval` command for dynamic environment setup

## Open Questions

1. **Virtual environment activation**: Should `make env` include Python venv activation if present? This may require more complex shell scripting.

2. **Multiple shells**: The current design targets bash. Should we support zsh/fish with different output formats?

3. **Clean target interaction**: Should `make clean` remove generated `setup.sh`? Current design says yes (line 501 of install.sh shows `@rm -f setup.sh` in clean target).

## Next Steps

This design is ready for:
1. Implementation issue creation
2. Development via /issue2impl

### Implementation Checklist

- [ ] Modify `generate_enhanced_makefile()` in `scripts/install.sh` to add `env` and `env-script` targets
- [ ] Add language-specific env exports for Python, C++, Rust
- [ ] Update README.md "Required Interface" section
- [ ] Update `make help` output
- [ ] Test with `make agentize` in init mode
- [ ] Test `eval $(make env)` works correctly
- [ ] Test `make env-script` generates valid setup.sh

---

*This draft was created through independent analysis of the codebase and user requirements.*
