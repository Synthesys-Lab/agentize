# Design Draft: Test Scripts Formalization

**Created**: 2025-12-20 22:18:19
**Status**: Draft - Brainstorming Complete

## Executive Summary

Formalize the testing strategy documented in README.md (lines 383-403) into executable test scripts in `tests/`. The design uses pure bash scripts with a custom assertion library, matching the project's existing style and requiring no external dependencies.

## Problem Statement

The README.md documents a testing strategy for verifying Agentize installation in different modes (init, port, multi-language), but these tests exist only as documentation. There are no actual test scripts that can be executed to verify the installation script works correctly. This makes it difficult to:

1. Verify changes to `scripts/install.sh` don't break functionality
2. Run automated tests in CI/CD pipelines
3. Validate new language templates work correctly

## Design Decision Record

### Key Decisions Made

| Decision | Choice | Rationale | Alternatives Considered |
|----------|--------|-----------|------------------------|
| Test framework | Pure bash | Matches project style, no dependencies | BATS (adds dependency), pytest (wrong language) |
| Directory structure | `tests/` with `lib/` subdirectory | Modular, supports shared utilities | Flat structure (less organized), Makefile-only (less maintainable) |
| Test isolation | Temp directories in `/tmp/agentize-test-*` | Clean state per test, easy cleanup | Fixed test directory (conflicts), in-place (dangerous) |
| Assertion style | Custom helper functions | Simple, readable, no dependencies | Built-in `test` only (verbose), external library (dependency) |
| Output format | Simple pass/fail with color | Human-readable, CI-compatible | TAP (overkill), JUnit XML (needs tool) |

### Critical Issues Resolved

1. **Isolation**: Each test creates a unique temporary directory to avoid conflicts
2. **Cleanup**: Automatic cleanup after tests, with option to preserve on failure for debugging
3. **Portability**: POSIX-compatible bash for cross-platform support

### Acknowledged Tradeoffs

1. **No TAP output**: Sacrificing structured test output for simplicity; can add later if needed
2. **Test duration**: Installation tests are inherently slow; accepted as necessary
3. **Manual test addition**: No auto-discovery; tests must be explicitly listed in runner

## Design Specification

### Overview

The test suite consists of:
- A runner script that executes all tests and reports results
- Individual test scripts for each installation scenario
- A shared assertion library for common checks

### Directory Structure

```
tests/
  run-all.sh              # Main test runner (executable)
  test-init-mode.sh       # Test: init mode creates full project structure
  test-port-mode.sh       # Test: port mode creates only .claude/
  test-languages.sh       # Test: language-specific template generation
  lib/
    assertions.sh         # Assertion functions (assert_file_exists, etc.)
    test-utils.sh         # Setup/teardown utilities
```

### Key Components

1. **run-all.sh**: Main entry point
   - Discovers and runs all `test-*.sh` files
   - Reports pass/fail counts
   - Returns non-zero exit code on any failure

2. **lib/assertions.sh**: Assertion library
   - `assert_file_exists <path>`: Verify file exists
   - `assert_dir_exists <path>`: Verify directory exists
   - `assert_file_contains <path> <pattern>`: Verify file contains pattern
   - `assert_command_succeeds <command>`: Verify command exits 0
   - `fail <message>`: Mark test as failed with message

3. **lib/test-utils.sh**: Test utilities
   - `create_test_dir`: Create unique temp directory
   - `cleanup_test_dir`: Remove temp directory
   - `run_agentize <args>`: Run make agentize with given args

4. **test-init-mode.sh**: Init mode tests
   - Verifies `.claude/` directory created
   - Verifies `docs/CLAUDE.md` created
   - Verifies `Makefile` created
   - Verifies `README.md` created
   - Verifies `.gitignore` created
   - Verifies `setup.sh` created

5. **test-port-mode.sh**: Port mode tests
   - Verifies `.claude/` directory created
   - Verifies NO `docs/` directory created
   - Verifies NO `Makefile` created (existing preserved)

6. **test-languages.sh**: Language template tests
   - Python: Verifies `pyproject.toml`, package directory
   - C++: Verifies `CMakeLists.txt`, `include/`, `src/`
   - Rust: Verifies `Cargo.toml`, `src/main.rs`
   - Multi-language: Verifies combined Makefile

### Interfaces

#### Assertion API

```bash
# Source the library
source "$(dirname "$0")/lib/assertions.sh"

# Use assertions
assert_file_exists "$TEST_DIR/.claude/CLAUDE.md"
assert_dir_exists "$TEST_DIR/.claude/agents"
assert_file_contains "$TEST_DIR/Makefile" "build-python"
```

#### Test Script Template

```bash
#!/bin/bash
# test-example.sh - Example test script

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/assertions.sh"
source "$SCRIPT_DIR/lib/test-utils.sh"

test_example_feature() {
    local test_dir
    test_dir=$(create_test_dir "example")

    # Run installation
    run_agentize "$test_dir" "TestProject" "init"

    # Verify results
    assert_file_exists "$test_dir/.claude/CLAUDE.md"

    # Cleanup
    cleanup_test_dir "$test_dir"
}

# Run test
test_example_feature
```

### Makefile Integration

Add to root `Makefile`:

```makefile
.PHONY: test
test:
	@echo "Running Agentize tests..."
	@bash tests/run-all.sh
```

### Constraints

1. **Bash 3.2 compatibility**: Must work on macOS default bash
2. **No external dependencies**: Only standard Unix tools
3. **Temp directory only**: Tests must not modify the source repository
4. **Idempotent cleanup**: Cleanup must be safe to run multiple times

## Test Coverage Matrix

| Feature | Test Script | Assertions |
|---------|-------------|------------|
| Init mode - .claude/ | test-init-mode.sh | Directory and file existence |
| Init mode - docs/ | test-init-mode.sh | Directory and docs/CLAUDE.md |
| Init mode - Makefile | test-init-mode.sh | File exists, contains build target |
| Port mode - .claude/ only | test-port-mode.sh | .claude/ exists, no docs/ |
| Python template | test-languages.sh | pyproject.toml, package dir |
| C++ template | test-languages.sh | CMakeLists.txt, include/, src/ |
| Rust template | test-languages.sh | Cargo.toml via cargo init |
| Multi-language | test-languages.sh | Combined Makefile targets |

## Research References

### Internal References
- `/Users/were/repos/playground/agentize/README.md` (lines 383-403): Original test documentation
- `/Users/were/repos/playground/agentize/scripts/install.sh`: Installation script being tested
- `/Users/were/repos/playground/agentize/Makefile`: Root Makefile to extend

### External References
- POSIX Shell Guidelines: Standard for portable shell scripts
- Bash 3.2 compatibility: Required for macOS support

## Open Questions

1. **Verbose mode**: Should there be a `--verbose` flag for debugging?
   - Recommendation: Add in implementation if useful

2. **Parallel execution**: Should tests run in parallel?
   - Recommendation: Not initially; add if test suite becomes slow

3. **CI integration**: Which CI system will run these tests?
   - Recommendation: Design for generic `make test` that works anywhere

## Next Steps

This design is ready for:
1. Implementation of `tests/` directory and scripts
2. Update of root Makefile with `test` target
3. Documentation update to reference `make test`

Implementation priority:
1. `lib/assertions.sh` and `lib/test-utils.sh` (foundation)
2. `test-init-mode.sh` (most common case)
3. `test-port-mode.sh` (second most common)
4. `test-languages.sh` (template verification)
5. `run-all.sh` (test runner)
6. Makefile integration

---

*This draft was created through independent analysis of the original idea and codebase.*
